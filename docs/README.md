# OSM Racing

3D гоночная игра на движке Godot 4 с загрузкой карт из OpenStreetMap.

## Структура проекта

```
osm-racing/
├── project.godot              # Конфигурация проекта
├── main.tscn                  # Главная сцена
├── car/
│   ├── car.tscn               # Сцена автомобиля (VehicleBody3D)
│   └── car.gd                 # Скрипт управления
├── camera/
│   └── follow_camera.gd       # Орбитальная камера с управлением мышью
├── osm/
│   ├── osm_loader.gd          # Загрузчик данных OpenStreetMap
│   └── osm_terrain_generator.gd # Генератор террейна из OSM данных
├── ui/
│   └── coordinates_display.gd # Отображение координат в UI
└── docs/
    └── README.md              # Эта документация
```

## Компоненты

### Автомобиль (car/)

**car.tscn** - сцена автомобиля на базе `VehicleBody3D`:
- Кузов: BoxMesh 2×1×4 м
- 4 колеса: цилиндры с радиусом 0.4 м
- Передние колёса - рулевые (`use_as_steering = true`)
- Задние колёса - ведущие (`use_as_traction = true`)

**car.gd** - управление:
- Стрелки влево/вправо - руление
- Стрелки вверх/вниз - газ/тормоз
- Пробел - ручной тормоз

Параметры:
- `engine_power`: 300.0 - мощность двигателя
- `steering_limit`: 0.4 рад (~23°) - максимальный угол поворота
- `steering_speed`: 3.0 - скорость поворота руля
- `brake_power`: 30.0 - сила торможения

### Камера (camera/)

**follow_camera.gd** - орбитальная камера:
- Мышь - вращение вокруг машины
- Колёсико мыши - приближение/отдаление (3-30 м)
- Escape - переключение захвата мыши

Параметры:
- `distance`: 10.0 - начальная дистанция
- `smooth_speed`: 5.0 - плавность следования
- `mouse_sensitivity`: 0.003 - чувствительность мыши

### OSM Загрузчик (osm/)

**osm_loader.gd** - загрузка данных из Overpass API:

Сигналы:
- `data_loaded(osm_data: Dictionary)` - данные загружены
- `load_failed(error: String)` - ошибка загрузки

Методы:
- `load_area(lat, lon, radius)` - загрузить область
- `latlon_to_local(lat, lon) -> Vector2` - конвертация в локальные метры

Загружаемые данные:
- Дороги (`highway`)
- Здания (`building`)
- Природа (`natural`)
- Землепользование (`landuse`)
- Досуг (`leisure`)
- Водные пути (`waterway`)

**osm_terrain_generator.gd** - генерация 3D террейна:

Параметры:
- `start_lat`, `start_lon` - начальные координаты
- `area_radius` - радиус загрузки в метрах

Генерируемые объекты:
- **Дороги** - плоские полосы разной ширины (1.5-12 м)
- **Здания** - 3D боксы с крышей и стенами, коллизией
- **Природные зоны** - цветные полигоны (вода, лес, трава)
- **Водные пути** - линейные объекты

Цветовая схема:
| Тип | Цвет |
|-----|------|
| Главная дорога | RGB(0.3, 0.3, 0.3) |
| Второстепенная дорога | RGB(0.4, 0.4, 0.4) |
| Жилая дорога | RGB(0.5, 0.5, 0.5) |
| Тропа | RGB(0.6, 0.5, 0.4) |
| Здание | RGB(0.6, 0.4, 0.3) |
| Вода | RGB(0.2, 0.4, 0.7) |
| Трава | RGB(0.3, 0.6, 0.3) |
| Лес | RGB(0.2, 0.5, 0.2) |

### UI (ui/)

**coordinates_display.gd** - отображение координат:
- Широта (Lat)
- Долгота (Lon)
- Высота (Alt)

## Запуск

1. Открыть проект в Godot 4.x
2. Запустить сцену `main.tscn`
3. Дождаться загрузки OSM данных (появится в консоли)

## Управление

| Клавиша | Действие |
|---------|----------|
| ↑ / W | Газ |
| ↓ / S | Тормоз/назад |
| ← / A | Поворот влево |
| → / D | Поворот вправо |
| Пробел | Ручной тормоз |
| Мышь | Вращение камеры |
| Колёсико | Зум |
| Escape | Освободить мышь |

## Координаты по умолчанию

Череповец, Россия: 59.149886, 37.949370

## Известные проблемы

1. При таймауте Overpass API (504) - повторить запуск
2. Дороги могут быть не видны при определённых условиях освещения

## Тестирование

Тесты находятся в папке `tests/`:

```
tests/
├── test_runner.tscn    # Сцена для запуска всех тестов
├── test_runner.gd      # Раннер тестов
└── test_osm_loader.gd  # Тесты OSM загрузчика
```

### Запуск тестов

**В Godot Editor:**
1. Открыть сцену `tests/test_runner.tscn`
2. Запустить (F5 или кнопка Play)
3. Результаты появятся в консоли Output

**Из командной строки:**
```bash
godot --headless -s tests/test_runner.gd
```

### Покрытие тестами

- `latlon_to_local()` - конвертация координат
- `_parse_osm_data()` - парсинг OSM данных

## Зависимости

- Godot 4.x
- Доступ к интернету (Overpass API)
