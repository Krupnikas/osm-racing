# OSM Racing

3D гоночная игра на движке Godot 4 с загрузкой карт из OpenStreetMap.

## Структура проекта

```
osm-racing/
├── project.godot              # Конфигурация проекта
├── main.tscn                  # Главная сцена
├── car/
│   ├── car.tscn               # Сцена автомобиля (VehicleBody3D)
│   ├── car.gd                 # Скрипт управления
│   └── audio/
│       └── engine_sound.gd    # Процедурный звук двигателя
├── camera/
│   ├── camera_manager.gd      # Менеджер режимов камеры
│   ├── follow_camera.gd       # Орбитальная камера (вид сзади)
│   ├── first_person_camera.gd # Камера от первого лица
│   └── top_down_camera.gd     # Вид сверху
├── osm/
│   ├── osm_loader.gd          # Загрузчик данных OpenStreetMap
│   ├── osm_terrain_generator.gd # Генератор террейна из OSM данных
│   └── elevation_loader.gd    # Загрузчик высот (Open-Elevation API)
├── textures/
│   ├── texture_generator.gd   # Процедурная генерация текстур
│   └── texture_manager.gd     # Кэширование текстур и материалов
├── ui/
│   ├── main_menu.gd           # Главное меню с выбором локации
│   ├── hud.gd                 # HUD (скорость, обороты, передача)
│   └── coordinates_display.gd # Отображение координат
└── docs/
    └── README.md              # Эта документация
```

## Компоненты

### Автомобиль (car/)

**car.tscn** - сцена автомобиля на базе `VehicleBody3D`:
- Кузов: BoxMesh 2×1×4 м
- 4 колеса: цилиндры с радиусом 0.35 м
- Передние колёса - рулевые (`use_as_steering = true`)
- Задние колёса - ведущие (`use_as_traction = true`)
- Процедурный звук двигателя (EngineSound)

**car.gd** - управление:
- Стрелки влево/вправо - руление
- Стрелки вверх/вниз - газ/тормоз
- Пробел - ручной тормоз

Параметры двигателя:
- `max_engine_power`: 300.0 - мощность двигателя (Н·м)
- `max_rpm`: 7000.0 - максимальные обороты
- `idle_rpm`: 900.0 - обороты холостого хода
- `gear_ratios`: [-3.5, 0.0, 3.5, 2.2, 1.4, 1.0, 0.8] - передачи (R, N, 1-5)
- `auto_transmission`: true - автоматическая КПП

Параметры управления:
- `max_steering_angle`: 35° - максимальный угол поворота
- `steering_speed`: 3.0 - скорость поворота руля
- `brake_force`: 30.0 - сила основных тормозов
- `handbrake_force`: 50.0 - сила ручного тормоза

Системы стабилизации:
- TCS (антипробуксовочная система)
- ESC (система стабилизации)

**audio/engine_sound.gd** - процедурный звук двигателя:
- Синтезируется в реальном времени на основе оборотов
- Изменяется pitch (0.5-2.0) и громкость (-15 до 0 dB)
- 3D позиционирование звука

### Камера (camera/)

**follow_camera.gd** - орбитальная камера:
- Мышь - вращение вокруг машины
- Колёсико мыши - приближение/отдаление (3-30 м)
- Escape - переключение захвата мыши

Параметры:
- `distance`: 10.0 - начальная дистанция
- `smooth_speed`: 5.0 - плавность следования
- `mouse_sensitivity`: 0.003 - чувствительность мыши

### OSM Загрузчик (osm/)

**osm_loader.gd** - загрузка данных из Overpass API:

Сигналы:
- `data_loaded(osm_data: Dictionary)` - данные загружены
- `load_failed(error: String)` - ошибка загрузки

Методы:
- `load_area(lat, lon, radius)` - загрузить область
- `latlon_to_local(lat, lon) -> Vector2` - конвертация в локальные метры

Загружаемые данные:
- Дороги (`highway`)
- Здания (`building`)
- Природа (`natural`)
- Землепользование (`landuse`)
- Досуг (`leisure`)
- Водные пути (`waterway`)

**osm_terrain_generator.gd** - генерация 3D террейна:

Параметры:
- `start_lat`, `start_lon` - начальные координаты
- `area_radius` - радиус загрузки в метрах

Генерируемые объекты:
- **Дороги** - плоские полосы разной ширины (1.5-12 м) с текстурами разметки
- **Бордюры** - вдоль дорог с коллизией (10см для primary, 8см для secondary и т.д.)
- **Здания** - 3D боксы с текстурами (панельки, кирпич), крышей и коллизией
- **Природные зоны** - текстурированные полигоны (трава, лес, вода)
- **Водные пути** - линейные объекты
- **Заборы** - вокруг зданий (кроме АЗС и парковок)

### Текстуры (textures/)

**texture_generator.gd** - процедурная генерация текстур:
- `create_highway_texture()` - магистрали с 4 полосами и жёлтой разделительной
- `create_road_texture()` - обычные дороги с разметкой
- `create_sidewalk_texture()` - тротуарная плитка
- `create_panel_building_texture()` - российские панельки с окнами и балконами
- `create_brick_building_texture()` - кирпичные дома
- `create_grass_texture()`, `create_forest_texture()`, `create_water_texture()`

**texture_manager.gd** - кэширование текстур и материалов

Цветовая схема:
| Тип | Цвет |
|-----|------|
| Главная дорога | RGB(0.3, 0.3, 0.3) |
| Второстепенная дорога | RGB(0.4, 0.4, 0.4) |
| Жилая дорога | RGB(0.5, 0.5, 0.5) |
| Тропа | RGB(0.6, 0.5, 0.4) |
| Здание | RGB(0.6, 0.4, 0.3) |
| Вода | RGB(0.2, 0.4, 0.7) |
| Трава | RGB(0.3, 0.6, 0.3) |
| Лес | RGB(0.2, 0.5, 0.2) |

### UI (ui/)

**coordinates_display.gd** - отображение координат:
- Широта (Lat)
- Долгота (Lon)
- Высота (Alt)

## Запуск

### Из Godot Editor:
1. Открыть проект в Godot 4.x
2. Запустить сцену `main.tscn` (F5)
3. Дождаться загрузки OSM данных (появится в консоли)

### Из командной строки (запуск игры напрямую):
```bash
/Applications/Godot.app/Contents/MacOS/Godot --path /Users/alekseiaksenov/osm-racing res://main.tscn
```

### Перезапуск игры:
```bash
killall -9 Godot 2>/dev/null; sleep 1 && /Applications/Godot.app/Contents/MacOS/Godot --path /Users/alekseiaksenov/osm-racing res://main.tscn 2>&1 &
```

## Управление

| Клавиша | Действие |
|---------|----------|
| ↑ / W | Газ |
| ↓ / S | Тормоз/назад |
| ← / A | Поворот влево |
| → / D | Поворот вправо |
| Пробел | Ручной тормоз |
| Мышь | Вращение камеры |
| Колёсико | Зум |
| Escape | Освободить мышь |

## Доступные локации

| Локация | Координаты |
|---------|------------|
| Череповец | 59.149886, 37.949370 |
| Москва (Отрадное) | 55.860580, 37.599646 |
| Тбилиси (Важа-Пшавела) | 41.723972, 44.730502 |
| Дубай (Крик) | 25.208591, 55.344100 |

## Известные проблемы

1. При таймауте Overpass API (504) - повторить запуск
2. Дороги могут быть не видны при определённых условиях освещения

## Тестирование

Тесты находятся в папке `tests/`:

```
tests/
├── test_runner.tscn    # Сцена для запуска всех тестов
├── test_runner.gd      # Раннер тестов
└── test_osm_loader.gd  # Тесты OSM загрузчика
```

### Запуск тестов

**В Godot Editor:**
1. Открыть сцену `tests/test_runner.tscn`
2. Запустить (F5 или кнопка Play)
3. Результаты появятся в консоли Output

**Из командной строки:**
```bash
godot --headless -s tests/test_runner.gd
```

### Покрытие тестами

- `latlon_to_local()` - конвертация координат
- `_parse_osm_data()` - парсинг OSM данных

## Зависимости

- Godot 4.x
- Доступ к интернету (Overpass API)
